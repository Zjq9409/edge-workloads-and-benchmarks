#!/bin/bash

# Pipeline 配置参数
VIDEO_FILE="./1280x720_25fps.h265"
MODEL_PATH="/home/dlstreamer/FP16/yolo11n.xml"
GPU_DEVICE="GPU.1"
BATCH_SIZE=32
FPS_STARTING_FRAME=2000

echo "启动 10 路视频流..."

GSTREAMER_THREAD_PRIORITY=high gst-launch-1.0 -e \
multifilesrc location=${VIDEO_FILE} loop=true name=src1 ! h265parse ! vah265dec ! vapostproc ! "video/x-raw(memory:VAMemory)" ! gvadetect model=${MODEL_PATH} device=${GPU_DEVICE} pre-process-backend=vaapi-surface-sharing model-instance-id=inf0 batch_size=${BATCH_SIZE} ! gvatrack tracking-type=zero-term-imageless ! gvametaconvert source="DS-2CD2525EFV3-ITS20250630AACHGC4474347" add-empty-results=true json-indent=-1 timestamp-utc=true timestamp-microseconds=true ! queue ! gvametapublish method=mqtt address=localhost:1883 topic=dlstreamer async-handling=true ! gvafpscounter starting-frame=${FPS_STARTING_FRAME} \
multifilesrc location=${VIDEO_FILE} loop=true name=src2 ! h265parse ! vah265dec ! vapostproc ! "video/x-raw(memory:VAMemory)" ! gvadetect model=${MODEL_PATH} device=${GPU_DEVICE} pre-process-backend=vaapi-surface-sharing model-instance-id=inf0 batch_size=${BATCH_SIZE} ! gvatrack tracking-type=zero-term-imageless ! gvametaconvert source="DS-2CD2525EFV3-ITS20250625AACHGC2092061" add-empty-results=true json-indent=-1 timestamp-utc=true timestamp-microseconds=true ! queue ! gvametapublish method=mqtt address=localhost:1883 topic=dlstreamer async-handling=true ! gvafpscounter starting-frame=${FPS_STARTING_FRAME} \
multifilesrc location=${VIDEO_FILE} loop=true name=src3 ! h265parse ! vah265dec ! vapostproc ! "video/x-raw(memory:VAMemory)" ! gvadetect model=${MODEL_PATH} device=${GPU_DEVICE} pre-process-backend=vaapi-surface-sharing model-instance-id=inf0 batch_size=${BATCH_SIZE} ! gvatrack tracking-type=zero-term-imageless ! gvametaconvert source="DS-2CD2525EFV3-ITS20250625AACHGC2092061" add-empty-results=true json-indent=-1 timestamp-utc=true timestamp-microseconds=true ! queue ! gvametapublish method=mqtt address=localhost:1883 topic=dlstreamer async-handling=true ! gvafpscounter starting-frame=${FPS_STARTING_FRAME} \
multifilesrc location=${VIDEO_FILE} loop=true name=src4 ! h265parse ! vah265dec ! vapostproc ! "video/x-raw(memory:VAMemory)" ! gvadetect model=${MODEL_PATH} device=${GPU_DEVICE} pre-process-backend=vaapi-surface-sharing model-instance-id=inf0 batch_size=${BATCH_SIZE} ! gvatrack tracking-type=zero-term-imageless ! gvametaconvert source="DS-2CD2525EFV3-ITS20250625AACHGC2092061" add-empty-results=true json-indent=-1 timestamp-utc=true timestamp-microseconds=true ! queue ! gvametapublish method=mqtt address=localhost:1883 topic=dlstreamer async-handling=true ! gvafpscounter starting-frame=${FPS_STARTING_FRAME} \
multifilesrc location=${VIDEO_FILE} loop=true name=src5 ! h265parse ! vah265dec ! vapostproc ! "video/x-raw(memory:VAMemory)" ! gvadetect model=${MODEL_PATH} device=${GPU_DEVICE} pre-process-backend=vaapi-surface-sharing model-instance-id=inf0 batch_size=${BATCH_SIZE} ! gvatrack tracking-type=zero-term-imageless ! gvametaconvert source="DS-2CD2525EFV3-ITS20250625AACHGC2092061" add-empty-results=true json-indent=-1 timestamp-utc=true timestamp-microseconds=true ! queue ! gvametapublish method=mqtt address=localhost:1883 topic=dlstreamer async-handling=true ! gvafpscounter starting-frame=${FPS_STARTING_FRAME} \
multifilesrc location=${VIDEO_FILE} loop=true name=src6 ! h265parse ! vah265dec ! vapostproc ! "video/x-raw(memory:VAMemory)" ! gvadetect model=${MODEL_PATH} device=${GPU_DEVICE} pre-process-backend=vaapi-surface-sharing model-instance-id=inf0 batch_size=${BATCH_SIZE} ! gvatrack tracking-type=zero-term-imageless ! gvametaconvert source="DS-2CD2525EFV3-ITS20250625AACHGC2092061" add-empty-results=true json-indent=-1 timestamp-utc=true timestamp-microseconds=true ! queue ! gvametapublish method=mqtt address=localhost:1883 topic=dlstreamer async-handling=true ! gvafpscounter starting-frame=${FPS_STARTING_FRAME} \
multifilesrc location=${VIDEO_FILE} loop=true name=src7 ! h265parse ! vah265dec ! vapostproc ! "video/x-raw(memory:VAMemory)" ! gvadetect model=${MODEL_PATH} device=${GPU_DEVICE} pre-process-backend=vaapi-surface-sharing model-instance-id=inf0 batch_size=${BATCH_SIZE} ! gvatrack tracking-type=zero-term-imageless ! gvametaconvert source="DS-2CD2525EFV3-ITS20250625AACHGC2092061" add-empty-results=true json-indent=-1 timestamp-utc=true timestamp-microseconds=true ! queue ! gvametapublish method=mqtt address=localhost:1883 topic=dlstreamer async-handling=true ! gvafpscounter starting-frame=${FPS_STARTING_FRAME} \
multifilesrc location=${VIDEO_FILE} loop=true name=src8 ! h265parse ! vah265dec ! vapostproc ! "video/x-raw(memory:VAMemory)" ! gvadetect model=${MODEL_PATH} device=${GPU_DEVICE} pre-process-backend=vaapi-surface-sharing model-instance-id=inf0 batch_size=${BATCH_SIZE} ! gvatrack tracking-type=zero-term-imageless ! gvametaconvert source="DS-2CD2525EFV3-ITS20250625AACHGC2092061" add-empty-results=true json-indent=-1 timestamp-utc=true timestamp-microseconds=true ! queue ! gvametapublish method=mqtt address=localhost:1883 topic=dlstreamer async-handling=true ! gvafpscounter starting-frame=${FPS_STARTING_FRAME} \
multifilesrc location=${VIDEO_FILE} loop=true name=src9 ! h265parse ! vah265dec ! vapostproc ! "video/x-raw(memory:VAMemory)" ! gvadetect model=${MODEL_PATH} device=${GPU_DEVICE} pre-process-backend=vaapi-surface-sharing model-instance-id=inf0 batch_size=${BATCH_SIZE} ! gvatrack tracking-type=zero-term-imageless ! gvametaconvert source="DS-2CD2525EFV3-ITS20250630AACHGC4474347" add-empty-results=true json-indent=-1 timestamp-utc=true timestamp-microseconds=true ! queue ! gvametapublish method=mqtt address=localhost:1883 topic=dlstreamer async-handling=true ! gvafpscounter starting-frame=${FPS_STARTING_FRAME} \
multifilesrc location=${VIDEO_FILE} loop=true name=src10 ! h265parse ! vah265dec ! vapostproc ! "video/x-raw(memory:VAMemory)" ! gvadetect model=${MODEL_PATH} device=${GPU_DEVICE} pre-process-backend=vaapi-surface-sharing model-instance-id=inf0 batch_size=${BATCH_SIZE} ! gvatrack tracking-type=zero-term-imageless ! gvametaconvert source="DS-2CD2525EFV3-ITS20250625AACHGC2092061" add-empty-results=true json-indent=-1 timestamp-utc=true timestamp-microseconds=true ! queue ! gvametapublish method=mqtt address=localhost:1883 topic=dlstreamer async-handling=true ! gvafpscounter starting-frame=${FPS_STARTING_FRAME} \
! fakesink sync=false
